openapi: 3.0.3
info:
  title: Hatchway Demo API
  description: |
    Comprehensive demonstration of django-hatchway framework features.

    This API showcases:
    - Type-safe parameter sourcing (Path, Query, Body, File)
    - Pydantic schema validation
    - Multiple HTTP methods
    - Nested resources
    - File uploads
    - Custom error handling

    Built with [django-hatchway](https://github.com/andrewgodwin/django-hatchway)
  version: 1.0.0
  contact:
    name: Hatchway Demo
  license:
    name: BSD-3-Clause

servers:
  - url: http://localhost:8000/api
    description: Development server

tags:
  - name: health
    description: Health check endpoints
  - name: posts
    description: Blog post management
  - name: comments
    description: Comment management

paths:
  /health/:
    get:
      tags: [health]
      summary: Health check
      description: Returns API health status and database statistics
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  posts_count:
                    type: integer
                    example: 42
                  comments_count:
                    type: integer
                    example: 128

  /posts/:
    get:
      tags: [posts]
      summary: List posts
      description: Get paginated list of posts with optional filtering
      operationId: listPosts
      parameters:
        - name: published
          in: query
          description: Filter by published status
          schema:
            type: boolean
        - name: limit
          in: query
          description: Maximum number of posts to return
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          description: Number of posts to skip
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: tags
          in: query
          description: Filter by tags (can be specified multiple times)
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
      responses:
        '200':
          description: List of posts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PostList'

  /posts/create/:
    post:
      tags: [posts]
      summary: Create a post
      description: Create a new blog post
      operationId: createPost
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostCreate'
      responses:
        '201':
          description: Post created successfully
          headers:
            X-Created-Id:
              description: ID of the created post
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '400':
          $ref: '#/components/responses/ValidationError'

  /posts/create-with-file/:
    post:
      tags: [posts]
      summary: Create post with file
      description: Create a post with an optional file attachment
      operationId: createPostWithFile
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - title
                - content
                - author_id
              properties:
                title:
                  type: string
                  minLength: 1
                content:
                  type: string
                  minLength: 1
                author_id:
                  type: integer
                  minimum: 1
                attachment:
                  type: string
                  format: binary
      responses:
        '201':
          description: Post created with file
          content:
            application/json:
              schema:
                type: object
                properties:
                  post_id:
                    type: integer
                  title:
                    type: string
                  attachment_name:
                    type: string
                  attachment_size:
                    type: integer
        '400':
          $ref: '#/components/responses/ValidationError'

  /posts/bulk/:
    post:
      tags: [posts]
      summary: Bulk create posts
      description: Create multiple posts at once with optional dry-run
      operationId: bulkCreatePosts
      parameters:
        - name: dry_run
          in: query
          description: If true, validates without creating
          schema:
            type: boolean
            default: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - posts
              properties:
                posts:
                  type: array
                  items:
                    $ref: '#/components/schemas/PostCreate'
      responses:
        '200':
          description: Dry run result
          content:
            application/json:
              schema:
                type: object
                properties:
                  would_create:
                    type: integer
                  posts:
                    type: array
                    items:
                      $ref: '#/components/schemas/PostCreate'
        '201':
          description: Posts created
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    type: integer
                  ids:
                    type: array
                    items:
                      type: integer

  /posts/{id}/:
    get:
      tags: [posts]
      summary: Get post detail
      description: Retrieve a single post by ID
      operationId: getPost
      parameters:
        - $ref: '#/components/parameters/PostId'
      responses:
        '200':
          description: Post details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [posts]
      summary: Update post
      description: Partially update a post
      operationId: updatePost
      parameters:
        - $ref: '#/components/parameters/PostId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostUpdate'
      responses:
        '200':
          description: Post updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [posts]
      summary: Delete post
      description: Delete a post by ID
      operationId: deletePost
      parameters:
        - $ref: '#/components/parameters/PostId'
      responses:
        '200':
          description: Post deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                    example: true
                  id:
                    type: integer
        '404':
          $ref: '#/components/responses/NotFound'

  /posts/search/:
    get:
      tags: [posts]
      summary: Search posts
      description: Search posts by query string
      operationId: searchPosts
      parameters:
        - name: q
          in: query
          required: true
          description: Search query
          schema:
            type: string
        - name: author_id
          in: query
          description: Filter by author ID
          schema:
            type: integer
        - name: include_unpublished
          in: query
          description: Include unpublished posts
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PostList'

  /posts/{id}/stats/:
    get:
      tags: [posts]
      summary: Get post statistics
      description: Get statistics for a specific post
      operationId: getPostStats
      parameters:
        - $ref: '#/components/parameters/PostId'
        - name: include_private
          in: query
          description: Include stats for unpublished posts
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Post statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  title:
                    type: string
                  comment_count:
                    type: integer
                  tag_count:
                    type: integer
        '403':
          description: Cannot view stats for unpublished posts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  /posts/filter/:
    post:
      tags: [posts]
      summary: Advanced filtering
      description: Filter posts using dict parameters with square bracket notation
      operationId: filterPosts
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                filters[title]:
                  type: string
                  description: Filter by title (case-insensitive)
                filters[author_id]:
                  type: integer
                  description: Filter by author ID
                options[published_only]:
                  type: boolean
                  description: Show only published posts
          application/json:
            schema:
              type: object
              properties:
                filters:
                  type: object
                  additionalProperties:
                    oneOf:
                      - type: string
                      - type: integer
                options:
                  type: object
                  additionalProperties:
                    type: boolean
      responses:
        '200':
          description: Filtered posts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PostList'

  /posts/titles/:
    get:
      tags: [posts]
      summary: Get post titles
      description: Get just the titles of posts
      operationId: getPostTitles
      parameters:
        - name: author_id
          in: query
          description: Filter by author ID
          schema:
            type: integer
      responses:
        '200':
          description: List of titles
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /posts/tags/summary/:
    get:
      tags: [posts]
      summary: Get tag summary
      description: Get count of posts per tag
      operationId: getTagSummary
      responses:
        '200':
          description: Tag counts
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: integer
              example:
                django: 15
                python: 23
                tutorial: 8

  /posts/{post_id}/comments/:
    get:
      tags: [comments]
      summary: List post comments
      description: Get comments for a specific post
      operationId: listPostComments
      parameters:
        - name: post_id
          in: path
          required: true
          description: Post ID
          schema:
            type: integer
        - name: limit
          in: query
          description: Maximum number of comments
          schema:
            type: integer
            default: 10
            minimum: 1
      responses:
        '200':
          description: List of comments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Comment'
        '404':
          $ref: '#/components/responses/NotFound'

  /posts/{post_id}/comments/create/:
    post:
      tags: [comments]
      summary: Create comment
      description: Create a comment on a post
      operationId: createComment
      parameters:
        - name: post_id
          in: path
          required: true
          description: Post ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentCreate'
      responses:
        '201':
          description: Comment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  parameters:
    PostId:
      name: id
      in: path
      required: true
      description: Post ID
      schema:
        type: integer
        minimum: 1

  schemas:
    Post:
      type: object
      description: Full post details
      properties:
        id:
          type: integer
          readOnly: true
        title:
          type: string
          maxLength: 200
        content:
          type: string
        author_id:
          type: integer
        created_at:
          type: string
          format: date-time
          readOnly: true
        updated_at:
          type: string
          format: date-time
          readOnly: true
        published:
          type: boolean
        tags:
          type: array
          items:
            type: string
        comment_count:
          type: integer
          readOnly: true
          description: Number of comments (callable method)
      required:
        - id
        - title
        - content
        - author_id
        - created_at
        - updated_at
        - published
        - tags
        - comment_count

    PostList:
      type: object
      description: Simplified post for listing
      properties:
        id:
          type: integer
        title:
          type: string
        author_id:
          type: integer
        created_at:
          type: string
          format: date-time
        published:
          type: boolean
        comment_count:
          type: integer
      required:
        - id
        - title
        - author_id
        - created_at
        - published
        - comment_count

    PostCreate:
      type: object
      description: Schema for creating posts
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        content:
          type: string
          minLength: 1
        author_id:
          type: integer
          minimum: 1
        published:
          type: boolean
          default: false
        tags:
          type: array
          items:
            type: string
          default: []
      required:
        - title
        - content
        - author_id

    PostUpdate:
      type: object
      description: Schema for updating posts (all fields optional)
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        content:
          type: string
          minLength: 1
        published:
          type: boolean
        tags:
          type: array
          items:
            type: string

    Comment:
      type: object
      description: Comment on a post
      properties:
        id:
          type: integer
          readOnly: true
        post_id:
          type: integer
        author_name:
          type: string
          maxLength: 100
        content:
          type: string
        created_at:
          type: string
          format: date-time
          readOnly: true
        rating:
          type: integer
          minimum: 0
          maximum: 5
      required:
        - id
        - post_id
        - author_name
        - content
        - created_at
        - rating

    CommentCreate:
      type: object
      description: Schema for creating comments
      properties:
        author_name:
          type: string
          minLength: 1
          maxLength: 100
        content:
          type: string
          minLength: 1
        rating:
          type: integer
          minimum: 0
          maximum: 5
          default: 0
      required:
        - author_name
        - content

    Error:
      type: object
      description: Error response
      properties:
        error:
          type: string
          description: Error message
      required:
        - error

    ValidationError:
      type: object
      description: Validation error response
      properties:
        error:
          type: string
          example: invalid_input
        error_details:
          type: array
          items:
            type: object
            properties:
              loc:
                type: array
                items:
                  type: string
                description: Field location
              msg:
                type: string
                description: Error message
              type:
                type: string
                description: Error type

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
                example: Not found

    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
